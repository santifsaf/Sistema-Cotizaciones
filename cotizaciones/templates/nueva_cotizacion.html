{% extends "estructura_base.html" %}
{% load static %}
{% block content %}
    <link href="{% static 'nueva_cotizacion.css' %}" rel="stylesheet"> 
    <div class="container">
        <header>
            <h1>PRESUPUESTO NO VALIDO COMO FACTURA</h1>
        </header>
        <section class="company-details">
            <div class="invoice-details">
                <div class="row fecha-row">
                    <label for="fecha">Fecha:</label>
                    <input type="date" id="fecha" name="fecha" value="{{ fecha_actual }}">
                </div>
                
                <div class="row condicion-pago-row">
                    <label for="condiciones-pago">Condición de pago:</label>
                    <select id="condiciones-pago">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Precio de lista">Precio de lista</option>
                    </select>
                </div>
            </div>
            

            <div class="datos-empresa">
                <form method="GET" action="">
                    <div class="company-info">
                        <label for="empresa">Empresa:</label>
                        <select id="empresa" name="empresa" onchange="this.form.submit()">
                            <option value="">--</option>
                            {% for empresa in empresas %}
                                <option value="{{ empresa.id }}" {% if empresa.id == empresa_seleccionada.id %}selected{% endif %}>
                                    {{ empresa.nombre }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    {% if empresa_seleccionada %}
                    <div class="row">
                        <p><strong>CUIT:</strong> {{ empresa_seleccionada.cuit }}</p>
                        <p><strong>Teléfono:</strong> {{ empresa_seleccionada.telefono }}</p>
                        <p><strong>Mail:</strong> {{ empresa_seleccionada.mail }}</p>
                    </div>
                    {% endif %}
                    
                    <div class="datos-container">
                        <div class="client-details">
                            <label for="cliente">Cliente:</label>
                            <select id="cliente" name="cliente" onchange="this.form.submit()">
                                <option value="">--</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id }}" 
                                        {% if cliente_seleccionado and cliente.id == cliente_seleccionado.id %}selected{% endif %}>
                                        {{ cliente.nombre }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        {% if cliente_seleccionado %}
                            <div class="row">
                                <p><strong>Empresa:</strong> {{ cliente_seleccionado.nombre_empresa }}</p>
                                <p><strong>Mail:</strong> {{ cliente_seleccionado.mail }}</p>
                            </div>
                        {% endif %}
                    </div>    
                </form>
            </div>
        </section>
        
        
        <section class="invoice-items">
            <table>
                <thead>
                    <tr>
                        <th>Cant.</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Precio unit.</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="number" name="cantidad" value="1"></td>
                        <td>
                            <select id="articulo">
                                <option value="">-- Seleccione un artículo --</option>
                                {% for articulo in articulos %}
                                    <option value="{{ articulo.id }}" 
                                        data-descripcion="{{ articulo.descripcion }}" 
                                        data-precio="{{ articulo.precio }}">
                                        {{ articulo.nombre }}
                                    </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="text" name="descripcion" placeholder="Descripción" readonly></td>
                        <td><input type="text" name="precio" placeholder="$0.00" readonly></td>
                        <td><input type="text" name="totalArticulo" placeholder="$0.00" readonly></td>
                    </tr>
                </tbody>

                
            </table>
            <button id="agregarArticulo" type="button">+ Agregar artículo nuevo</button>
            <button>+ Añadir descuento</button>
            <button>+ Añadir costo envío</button>
        </section>

        
        
        <section class="notes">
            <textarea placeholder="Observaciones"></textarea>
        </section>
        
        <section class="totals">
            <div class="total">
                <label for="total">Total:</label>
                <input type="text" id="totalCot" placeholder="$0.00" readonly>
            </div>

            <label for="validez">La validez de este presupuesto es de 1 dia desde su emision. Consultar nuevamente los precios antes de efectuar la compra.</label>
        </section>
        
        <footer>
            <button>Descartar</button>
            <button>Descargar PDF</button>
            <button>Imprimir</button>
            <button>Enviar</button>
            <button>Guardar</button>
        </footer>
    </div>
</body>
</html>





<script>
    // Función para asignar eventos a una fila específica
    function asignarEventosFila(fila) {
        // Asignar evento al input de cantidad
        const cantidadInput = fila.querySelector('[name="cantidad"]');
        if (cantidadInput) {
            cantidadInput.addEventListener('change', function () {
                actualizarTotalesFila(fila); // Recalcula el total de la fila
                actualizarTotalesGenerales(); // Actualiza el total general
            });
        }

        // Asignar evento al select de artículo
        const articuloSelect = fila.querySelector('[name="articulo"]');
        if (articuloSelect) {
            articuloSelect.addEventListener('change', completarCampos); // Completa los campos de la fila
        }
    }

    // Función que se ejecuta al cargar la página
    window.onload = function () {
        // Asignar evento al primer select de artículo
        const primerSelect = document.getElementById('articulo');
        primerSelect.addEventListener('change', completarCampos);

        // Asignar evento al select de condiciones de pago
        document.getElementById('condiciones-pago').addEventListener('change', function () {
            const filas = document.querySelectorAll('.invoice-items tbody tr');
            filas.forEach(actualizarTotalesFila); // Recalcula los precios de todas las filas
            actualizarTotalesGenerales(); // Actualiza el total general
        });

        // Asignar evento al botón para agregar un nuevo artículo
        document.getElementById('agregarArticulo').addEventListener('click', agregarArticuloNuevo);

        // Asignar eventos a las filas existentes al cargar la página
        const filas = document.querySelectorAll('.invoice-items tbody tr');
        filas.forEach(asignarEventosFila);
    };

    // Función para recalcular el total de una fila
    function actualizarTotalesFila(fila) {
        const precioInput = fila.querySelector('[name="precio"]');
        const cantidadInput = fila.querySelector('[name="cantidad"]');
        const totalInput = fila.querySelector('[name="totalArticulo"]');

        // Validar que los elementos necesarios existan
        if (!precioInput || !cantidadInput || !totalInput) {
            console.error('No se encontraron los elementos necesarios en la fila.');
            return;
        }

        // Obtener valores de precio y cantidad
        const precio = parseFloat(precioInput.getAttribute('data-precio-original')) || 0;
        const cantidad = parseInt(cantidadInput.value) || 0;
        const condicionPago = document.getElementById('condiciones-pago').value;

        // Aplicar descuento si la condición de pago es "Efectivo"
        let precioFinal = precio;
        if (condicionPago === "Efectivo") {
            precioFinal = precio * 0.9;
        }

        // Calcular el total de la fila
        const totalCalculado = precioFinal * cantidad;
        precioInput.value = `$${precioFinal.toFixed(2)}`;
        totalInput.value = `$${totalCalculado.toFixed(2)}`;

        // Actualizar el total general
        actualizarTotalesGenerales();
    }

    // Función para recalcular el total general
    function actualizarTotalesGenerales() {
        const filas = document.querySelectorAll('.invoice-items tbody tr');
        let totalGeneral = 0;

        // Sumar los totales de todas las filas
        filas.forEach(fila => {
            const total = fila.querySelector('[name="totalArticulo"]');
            const valor = parseFloat(total.value.replace('$', '')) || 0;
            totalGeneral += valor;
        });

        // Actualizar el campo de total general
        document.getElementById('totalCot').value = `$${totalGeneral.toFixed(2)}`;
    }

    // Función para completar los campos de una fila al seleccionar un artículo
    function completarCampos(e) {
        const fila = e.target.closest('tr');
        const select = e.target;
        const descripcion = fila.querySelector('[name="descripcion"]');
        const precio = fila.querySelector('[name="precio"]');
        const total = fila.querySelector('[name="totalArticulo"]');

        const selectedOption = select.options[select.selectedIndex];

        if (selectedOption.value) {
            // Completar los campos con los datos del artículo seleccionado
            descripcion.value = selectedOption.getAttribute('data-descripcion');
            const precioOriginal = parseFloat(selectedOption.getAttribute('data-precio'));
            precio.value = `$${precioOriginal.toFixed(2)}`;
            precio.setAttribute('data-precio-original', precioOriginal);
            actualizarTotalesFila(fila); // Recalcular el total de la fila
        } else {
            // Limpiar los campos si no se selecciona un artículo
            descripcion.value = '';
            precio.value = '';
            total.value = '$0.00';
            actualizarTotalesFila(fila);
        }

        actualizarTotalesGenerales(); // Actualizar el total general
    }

    // Función para agregar una nueva fila de artículo
    function agregarArticuloNuevo() {
        const tabla = document.querySelector('.invoice-items tbody');
        const nuevaFila = document.createElement('tr');
        nuevaFila.classList.add('fila-articulo');

        // Crear celda para la cantidad
        const tdCantidad = document.createElement('td');
        const inputCantidad = document.createElement('input');
        inputCantidad.name = "cantidad";
        inputCantidad.type = "number";
        inputCantidad.value = "1";
        tdCantidad.appendChild(inputCantidad);
        nuevaFila.appendChild(tdCantidad);

        // Crear celda para el select de artículo
        const tdSelect = document.createElement('td');
        const select = document.createElement('select');
        select.name = "articulo";

        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Seleccione un artículo --';
        select.appendChild(defaultOption);

        const existingSelect = document.getElementById('articulo');
        if (existingSelect) {
            Array.from(existingSelect.options).forEach(option => {
                select.appendChild(option.cloneNode(true));
            });
        } else {
            console.error('El select con ID "articulo" no existe.');
        }

        tdSelect.appendChild(select);
        nuevaFila.appendChild(tdSelect);

        // Crear celdas para descripción, precio y total
        ['descripcion', 'precio', 'totalArticulo'].forEach(name => {
            const td = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            input.name = name;
            input.readOnly = true;
            input.placeholder = name === 'totalArticulo' ? '$0.00' : '';
            td.appendChild(input);
            nuevaFila.appendChild(td);
        });

        // Agregar la nueva fila a la tabla
        tabla.appendChild(nuevaFila);

        // Asignar eventos a la nueva fila
        asignarEventosFila(nuevaFila);

        // Actualizar el total general
        actualizarTotalesGenerales();
    }
</script>





{% endblock %}
